<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EXAMEN DE LA ANTIGUA GRECIA Y LAS OLIMPIADAS</title>

  <!-- PDF (OPCI√ìN B): jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --text:#e8ecff;
      --muted:#b9c2ff;
      --border:#263159;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --ok:#22c55e;
      --bad:#ef4444;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% 10%, #16204a 0%, var(--bg) 55%);
      color: var(--text);
      text-transform: uppercase;
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px 14px 40px; }

    header{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .titleRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 12px;
      flex-wrap: wrap;
    }
    h1{
      font-size: clamp(18px, 3.2vw, 28px);
      margin: 0;
      letter-spacing: .5px;
      line-height: 1.15;
      flex: 1 1 520px;
    }
    .smallBtns{ display:flex; gap: 8px; align-items:center; flex: 0 0 auto; }
    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: .5px;
      user-select: none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
    }
    .btn:active{ transform: translateY(1px); }
    .mini{
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 1000;
      font-size: 14px;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.25;
    }

    .sectionTitle{
      margin: 20px 2px 10px;
      font-weight: 1000;
      letter-spacing: 1px;
      color: #ffffff;
      opacity:.95;
    }

    .qCard{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 100px 0; /* 100PX ENTRE PREGUNTAS */
    }
    .qHead{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:flex-start;
      flex-wrap: wrap;
    }
    .qText{
      font-size: 18px;
      line-height: 1.25;
      font-weight: 1000;
      margin: 0;
      flex: 1 1 520px;
    }

    .options{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .opt{
      border: 2px solid transparent;
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(255,255,255,.05);
      display:flex;
      gap: 10px;
      align-items:center;
      cursor:pointer;
      transition: transform .05s ease, border-color .12s ease, background .12s ease;
    }
    .opt:active{ transform: translateY(1px); }
    .opt.selected{
      border-color: #000000; /* RECUADRO NEGRO */
      background: rgba(255,255,255,.07);
    }
    .optKey{
      font-weight: 1100;
      min-width: 44px;
      display:flex;
      justify-content:center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.20);
    }
    .optText{
      font-size: 16px;
      font-weight: 900;
      line-height: 1.2;
      flex: 1 1 auto;
    }

    .footerBar{
      margin-top: 16px;
      display:flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
    }
    .primary{
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 14px;
    }

    /* WORD HIGHLIGHT */
    .ttsSpan{ padding: 1px 2px; border-radius: 6px; }
    .ttsActive{ background: rgba(255,255,255,.22); outline: 2px solid rgba(255,255,255,.12); }

    /* RESULTS */
    #results{ display:none; }
    .resultCard{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 18px 14px;
      box-shadow: var(--shadow);
      margin-top: 18px;
      text-align: center;
    }
    .big{
      font-size: clamp(22px, 4.2vw, 44px);
      font-weight: 1100;
      margin: 6px 0 8px;
      letter-spacing: 1px;
    }
    .grade{
      font-size: clamp(34px, 6.2vw, 64px);
      font-weight: 1200;
      margin: 0;
    }
    .badList{
      margin-top: 16px;
      display:grid;
      gap: 12px;
    }
    .badItem{
      text-align:left;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .badQ{
      font-weight: 1100;
      margin: 0 0 10px;
      line-height: 1.2;
      display:flex;
      gap:10px;
      justify-content: space-between;
      flex-wrap: wrap;
      align-items:flex-start;
    }
    .answersRow{
      display:grid;
      gap: 8px;
    }
    .tag{
      font-weight: 1100;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .chosen{ color: var(--bad); font-weight: 1100; }
    .correct{ color: var(--ok); font-weight: 1100; }
    .note{
      color: var(--muted);
      font-weight: 900;
      line-height: 1.25;
      margin-top: 10px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="titleRow">
        <h1 id="titleText" data-raw="EXAMEN DE LA ANTIGUA GRECIA Y LAS OLIMPIADAS">EXAMEN DE LA ANTIGUA GRECIA Y LAS OLIMPIADAS</h1>
        <div class="smallBtns">
          <button class="btn mini" id="titlePlay" type="button" aria-label="LEER T√çTULO NORMAL">‚ñ∂</button>
          <button class="btn mini" id="titleTurtle" type="button" aria-pressed="false" aria-label="LEER T√çTULO LENTO">üê¢</button>
        </div>
      </div>
    </header>

    <main id="exam">
  
      <div id="grecia"></div>

      <div id="olimpiadas"></div>

      <div class="footerBar">
        <button class="btn primary" id="gradePlay" type="button" aria-label="LEER CORREGIR Y NOTA NORMAL">‚ñ∂ LEER</button>
        <button class="btn primary" id="gradeTurtle" type="button" aria-pressed="false" aria-label="LEER CORREGIR Y NOTA LENTO">üê¢ LENTO</button>
        <button class="btn primary" id="gradeBtn" type="button" data-raw="CORREGIR Y NOTA">CORREGIR Y NOTA</button>
      </div>
      <div class="note" id="warn" data-raw=""></div>
    </main>

    <section id="results">
      <div class="resultCard">
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="btn mini" id="resultPlay" type="button">‚ñ∂</button>
          <button class="btn mini" id="resultTurtle" type="button" aria-pressed="false">üê¢</button>
        </div>
        <div class="big" id="resultTitle" data-raw="TU NOTA ES‚Ä¶">TU NOTA ES‚Ä¶</div>
        <div class="grade" id="resultGrade" data-raw="0,0 / 10">0,0 / 10</div>
      </div>

      <div class="badList" id="badList"></div>
      <div class="note" id="backNote" data-raw=""></div>
    </section>
  </div>

  <script>
    // -----------------------------
    // DATA (SOLO TU CONTENIDO)
    // -----------------------------
    const QUESTIONS = [
      // GRECIA (10)
      { id: 1, section: "grecia",
        q: "HACE MUCHO TIEMPO EXIST√çA‚Ä¶",
        opts: { A:"GRECIA ANTIGUA", B:"INTERNET", C:"TEL√âFONOS M√ìVILES" },
        correct: "A"
      },
      { id: 2, section: "grecia",
        q: "LAS PERSONAS QUE PENSABAN MUCHO Y PREGUNTABAN COSAS A LA GENTE SE LLAMABAN‚Ä¶",
        opts: { A:"REYES", B:"ATLETAS", C:"FIL√ìSOFOS" },
        correct: "C"
      },
      { id: 3, section: "grecia",
        q: "LOS FIL√ìSOFOS PREGUNTABAN SOBRE‚Ä¶",
        opts: { A:"C√ìMO GANAR CARRERAS", B:"QU√â ES LA VIDA, LO JUSTO Y LA VERDAD", C:"C√ìMO HACER DINERO" },
        correct: "B"
      },
      { id: 4, section: "grecia",
        q: "FIL√ìSOFOS SIGNIFICA‚Ä¶",
        opts: { A:"AMIGOS DE LA GUERRA", B:"AMIGOS DEL DINERO", C:"AMIGOS DE LA SABIDUR√çA" },
        correct: "C"
      },
      { id: 5, section: "grecia",
        q: "DEMOCRACIA SIGNIFICA‚Ä¶",
        opts: { A:"EL REY DECIDE", B:"EL PUEBLO DECIDE", C:"LOS SOLDADOS DECIDEN" },
        correct: "B"
      },
      { id: 6, section: "grecia",
        q: "EN LA DEMOCRACIA‚Ä¶",
        opts: { A:"SE HABLABA Y SE VOTABA Y SE ELEG√çAN RESPONSABLES", B:"DECID√çA SOLO UN REY", C:"NO SE VOTABA NUNCA" },
        correct: "A"
      },
      { id: 7, section: "grecia",
        q: "EN GRECIA CONTABAN HISTORIAS EN‚Ä¶",
        opts: { A:"UN MERCADO", B:"UN TEATRO", C:"UNA GUERRA" },
        correct: "B"
      },
      { id: 8, section: "grecia",
        q: "EN EL TEATRO HAB√çA‚Ä¶",
        opts: { A:"ACTORES, M√ÅSCARAS Y P√öBLICO", B:"SOLO REYES", C:"SOLO SOLDADOS" },
        correct: "A"
      },
      { id: 9, section: "grecia",
        q: "EN GRECIA CONSTRU√çAN‚Ä¶",
        opts: { A:"TEMPLOS Y EDIFICIOS MUY BONITOS", B:"RASCACIELOS", C:"AEROPUERTOS" },
        correct: "A"
      },
      { id: 10, section: "grecia",
        q: "HOY, MUCHOS EDIFICIOS USAN IDEAS PARECIDAS A GRECIA COMO‚Ä¶",
        opts: { A:"COLUMNAS, ESCALERAS Y FACHADAS", B:"NE√ìN Y PL√ÅSTICO", C:"ROBOTS Y DRONES" },
        correct: "A"
      },

      // OLIMPIADAS (5)
      { id: 11, section: "olimpiadas",
        q: "¬øQU√â ERAN LAS OLIMPIADAS?",
        opts: { A:"GUERRAS", B:"PELEAS", C:"JUEGOS DEPORTIVOS" },
        correct: "C"
      },
      { id: 12, section: "olimpiadas",
        q: "LAS OLIMPIADAS SE HAC√çAN SIEMPRE EN EL MISMO LUGAR. ESE LUGAR SE LLAMABA‚Ä¶",
        opts: { A:"ATENAS", B:"OLIMPIA", C:"ROMA" },
        correct: "B"
      },
      { id: 13, section: "olimpiadas",
        q: "CADA ATLETA COMPET√çA‚Ä¶",
        opts: { A:"EN EQUIPO", B:"SOLO", C:"CON SU FAMILIA" },
        correct: "B"
      },
      { id: 14, section: "olimpiadas",
        q: "EL GANADOR NO RECIB√çA DINERO. RECIB√çA‚Ä¶",
        opts: { A:"UNA MEDALLA", B:"UNA CORONA DE HOJAS", C:"UN TROFEO DE ORO" },
        correct: "B"
      },
      { id: 15, section: "olimpiadas",
        q: "EL GANADOR ERA MUY‚Ä¶",
        opts: { A:"CASTIGADO", B:"RESPETADO", C:"OLVIDADO" },
        correct: "B"
      }
    ];

    // -----------------------------
    // STATE
    // -----------------------------
    const state = {
      selected: new Map(), // qid -> 'A'|'B'|'C'
      slowJob: null,       // { stop: true/false }
      resultSpeechText: "TU NOTA ES‚Ä¶ 0,0 / 10"
    };

    // -----------------------------
    // SPEECH UTILS
    // -----------------------------
    function supportsSpeech(){
      return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
    }

    function stopAllSpeech(){
      try { window.speechSynthesis.cancel(); } catch(e){}
      stopSlowJob();
      clearAllHighlights();
    }

    function stopSlowJob(){
      if (state.slowJob) state.slowJob.stop = true;
      state.slowJob = null;
    }

    function normalizeTextForSpeech(text){
      return String(text).replace(/\s+/g, " ").trim();
    }

    function getRawText(el, fallback=""){
      const raw = el?.dataset?.raw;
      if (raw && raw.trim().length) return raw;
      return fallback || (el ? normalizeTextForSpeech(el.textContent) : "");
    }

    function setHighlightable(el, text){
      el.innerHTML = "";
      const words = normalizeTextForSpeech(text).split(" ");
      words.forEach((w, i) => {
        const span = document.createElement("span");
        span.className = "ttsSpan";
        span.textContent = w + (i < words.length - 1 ? " " : "");
        el.appendChild(span);
      });
      return el.querySelectorAll(".ttsSpan");
    }

    function clearAllHighlights(){
      document.querySelectorAll(".ttsActive").forEach(s => s.classList.remove("ttsActive"));
    }

    function getSpanishVoice(){
      const voices = window.speechSynthesis.getVoices?.() || [];
      const es = voices.filter(v => (v.lang || "").toLowerCase().startsWith("es"));
      const esES = es.find(v => (v.lang || "").toLowerCase() === "es-es");
      return esES || es[0] || voices[0] || null;
    }

    function speakNormal(text){
      if (!supportsSpeech()) return;
      stopAllSpeech();
      const u = new SpeechSynthesisUtterance(normalizeTextForSpeech(text));
      const v = getSpanishVoice();
      if (v) u.voice = v;
      u.lang = (v && v.lang) ? v.lang : "es-ES";
      u.rate = 1.0;
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
    }

    async function speakSlowWordByWord(targetEl, text, job){
      if (!supportsSpeech()) return;

      stopAllSpeech();
      state.slowJob = job;

      const raw = normalizeTextForSpeech(text);
      const words = raw.split(" ");
      const spans = setHighlightable(targetEl, raw);

      const v = getSpanishVoice();
      const lang = (v && v.lang) ? v.lang : "es-ES";

      try{
        for (let i = 0; i < words.length; i++){
          if (job.stop) break;

          clearAllHighlights();
          if (spans[i]) spans[i].classList.add("ttsActive");

          await new Promise(resolve => {
            if (job.stop) return resolve();
            const u = new SpeechSynthesisUtterance(words[i]);
            if (v) u.voice = v;
            u.lang = lang;
            u.rate = 0.70;
            u.pitch = 1.0;
            u.volume = 1.0;
            u.onend = () => resolve();
            u.onerror = () => resolve();
            window.speechSynthesis.speak(u);
          });

          await new Promise(r => setTimeout(r, 80));
        }
      } finally{
        clearAllHighlights();
        // IMPORTANT: RESTAURA TEXTO PLANO (EVITA REPETICIONES RARAS DESPU√âS)
        targetEl.textContent = raw;
        stopSlowJob();
      }
    }

    // FIX BUG: PARA ‚ñ∂ NORMAL SIEMPRE USAMOS TEXTO "RAW" (NO textContent CON SPANS)
    function speakFromButton(textEl, rawText, slow, toggleBtn){
      if (!supportsSpeech()){
        alert("TU NAVEGADOR NO SOPORTA LECTOR DE VOZ.");
        return;
      }

      // NORMAL
      if (!slow){
        if (toggleBtn) toggleBtn.setAttribute("aria-pressed", "false");
        // aseguramos texto plano y estable
        stopAllSpeech();
        const clean = normalizeTextForSpeech(rawText);
        if (textEl) {
          textEl.dataset.raw = clean;
          textEl.textContent = clean;
        }
        speakNormal(clean);
        return;
      }

      // LENTO TOGGLE (POR TEXTO)
      const pressed = (toggleBtn?.getAttribute("aria-pressed") === "true");
      if (pressed){
        toggleBtn.setAttribute("aria-pressed", "false");
        stopAllSpeech();
        return;
      }

      if (toggleBtn) toggleBtn.setAttribute("aria-pressed", "true");
      const clean = normalizeTextForSpeech(rawText);
      if (textEl) textEl.dataset.raw = clean;

      const job = { stop: false };
      speakSlowWordByWord(textEl, clean, job).finally(() => {
        if (toggleBtn) toggleBtn.setAttribute("aria-pressed", "false");
      });
    }

    // -----------------------------
    // RENDER
    // -----------------------------
    function makeQuestionCard(item){
      const card = document.createElement("div");
      card.className = "qCard";
      card.dataset.qid = item.id;

      const head = document.createElement("div");
      head.className = "qHead";

      const qP = document.createElement("p");
      qP.className = "qText";
      const qRaw = `${item.id}Ô∏è‚É£ ${item.q}`;
      qP.textContent = qRaw;
      qP.dataset.raw = qRaw;

      const btns = document.createElement("div");
      btns.className = "smallBtns";

      const play = document.createElement("button");
      play.type = "button";
      play.className = "btn mini";
      play.textContent = "‚ñ∂";
      play.setAttribute("aria-label", "LEER PREGUNTA NORMAL");

      const turtle = document.createElement("button");
      turtle.type = "button";
      turtle.className = "btn mini";
      turtle.textContent = "üê¢";
      turtle.setAttribute("aria-pressed", "false");
      turtle.setAttribute("aria-label", "LEER PREGUNTA LENTO");

      play.addEventListener("click", () => speakFromButton(qP, qRaw, false, turtle));
      turtle.addEventListener("click", () => speakFromButton(qP, qRaw, true, turtle));

      btns.appendChild(play);
      btns.appendChild(turtle);

      head.appendChild(qP);
      head.appendChild(btns);

      const opts = document.createElement("div");
      opts.className = "options";

      const keys = ["A","B","C"];
      keys.forEach(k => {
        const opt = document.createElement("div");
        opt.className = "opt";
        opt.dataset.key = k;

        const keyBox = document.createElement("div");
        keyBox.className = "optKey";
        keyBox.textContent = `${k})`;

        const text = document.createElement("div");
        text.className = "optText";
        const optRaw = `${k}) ${item.opts[k]}`;
        text.textContent = item.opts[k];
        text.dataset.raw = optRaw;

        const playOpt = document.createElement("button");
        playOpt.type = "button";
        playOpt.className = "btn mini";
        playOpt.textContent = "‚ñ∂";
        playOpt.setAttribute("aria-label", `LEER RESPUESTA ${k} NORMAL`);

        const turtleOpt = document.createElement("button");
        turtleOpt.type = "button";
        turtleOpt.className = "btn mini";
        turtleOpt.textContent = "üê¢";
        turtleOpt.setAttribute("aria-pressed", "false");
        turtleOpt.setAttribute("aria-label", `LEER RESPUESTA ${k} LENTO`);

        playOpt.addEventListener("click", (e) => {
          e.stopPropagation();
          speakFromButton(text, optRaw, false, turtleOpt);
        });
        turtleOpt.addEventListener("click", (e) => {
          e.stopPropagation();
          speakFromButton(text, optRaw, true, turtleOpt);
        });

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "8px";
        right.style.alignItems = "center";
        right.appendChild(playOpt);
        right.appendChild(turtleOpt);

        opt.appendChild(keyBox);
        opt.appendChild(text);
        opt.appendChild(right);

        opt.addEventListener("click", () => selectOption(item.id, k));
        opts.appendChild(opt);
      });

      card.appendChild(head);
      card.appendChild(opts);
      return card;
    }

    function render(){
      const g = document.getElementById("grecia");
      const o = document.getElementById("olimpiadas");
      g.innerHTML = "";
      o.innerHTML = "";

      QUESTIONS.forEach(q => {
        const card = makeQuestionCard(q);
        if (q.section === "grecia") g.appendChild(card);
        else o.appendChild(card);
      });

      refreshSelections();
    }

    function refreshSelections(){
      document.querySelectorAll(".qCard").forEach(card => {
        const qid = Number(card.dataset.qid);
        const chosen = state.selected.get(qid) || null;
        card.querySelectorAll(".opt").forEach(opt => {
          const k = opt.dataset.key;
          opt.classList.toggle("selected", chosen === k);
        });
      });
    }

    function selectOption(qid, key){
      state.selected.set(qid, key);
      refreshSelections();
    }

    function ensureAllAnswered(){
      for (const q of QUESTIONS){
        if (!state.selected.get(q.id)) return false;
      }
      return true;
    }

    // -----------------------------
    // PDF (OPCI√ìN B)
    // -----------------------------
    function generatePDF(){
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF){
        alert("NO SE HA PODIDO CARGAR EL GENERADOR DE PDF.");
        return;
      }

      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 48;
      const maxW = pageW - margin * 2;

      const title = "EXAMEN DE LA ANTIGUA GRECIA Y LAS OLIMPIADAS";
      const when = new Date().toLocaleString("es-ES");

      let y = margin;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text(title, margin, y);
      y += 18;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`FECHA: ${when}`.toUpperCase(), margin, y);
      y += 22;

      doc.setFontSize(11);

      function addLine(text){
        const lines = doc.splitTextToSize(String(text).toUpperCase(), maxW);
        for (const line of lines){
          if (y > pageH - margin){
            doc.addPage();
            y = margin;
          }
          doc.text(line, margin, y);
          y += 16;
        }
      }

      QUESTIONS.forEach((q) => {
        const chosenKey = state.selected.get(q.id) || "";
        const chosenText = chosenKey ? `${chosenKey}) ${q.opts[chosenKey]}` : "NO CONTESTASTE";
        addLine(`${q.id}) ${q.q}`);
        addLine(`RESPUESTA ELEGIDA: ${chosenText}`);
        y += 8;
      });

      doc.save("EXAMEN_ANTIGUA_GRECIA_Y_OLIMPIADAS.pdf");
    }

    // -----------------------------
    // GRADING + RESULTS
    // -----------------------------
    function grade(){
      stopAllSpeech();

      const total = QUESTIONS.length;
      let correctCount = 0;
      const wrongItems = [];

      for (const q of QUESTIONS){
        const chosen = state.selected.get(q.id) || null;
        const isCorrect = chosen && chosen === q.correct;
        if (isCorrect) correctCount++;
        else wrongItems.push({ q, chosen, correct: q.correct });
      }

      const score10 = (correctCount / total) * 10;
      const scoreStr = score10.toFixed(1).replace(".", ",");

      // Result speech text FIXED (NO textContent)
      state.resultSpeechText = `TU NOTA ES‚Ä¶ ${scoreStr} / 10`;

      // Hide exam, show results
      document.getElementById("exam").style.display = "none";
      document.getElementById("results").style.display = "block";

      const resultTitle = document.getElementById("resultTitle");
      const resultGrade = document.getElementById("resultGrade");
      resultTitle.dataset.raw = "TU NOTA ES‚Ä¶";
      resultTitle.textContent = "TU NOTA ES‚Ä¶";
      resultGrade.dataset.raw = `${scoreStr} / 10`;
      resultGrade.textContent = `${scoreStr} / 10`;

      // Build wrong list
      const badList = document.getElementById("badList");
      badList.innerHTML = "";

      if (wrongItems.length === 0){
        const allGood = document.createElement("div");
        allGood.className = "badItem";
        allGood.innerHTML = `<p class="badQ">¬°TODO PERFECTO! ‚úÖ</p>`;
        badList.appendChild(allGood);
      } else {
        wrongItems.forEach(w => {
          const item = document.createElement("div");
          item.className = "badItem";

          const qLine = document.createElement("div");
          qLine.className = "badQ";

          const qText = document.createElement("div");
          const qRaw = `${w.q.id}Ô∏è‚É£ ${w.q.q}`;
          qText.textContent = qRaw;
          qText.dataset.raw = qRaw;

          const qBtns = document.createElement("div");
          qBtns.className = "smallBtns";

          const bPlay = document.createElement("button");
          bPlay.type = "button";
          bPlay.className = "btn mini";
          bPlay.textContent = "‚ñ∂";

          const bTurtle = document.createElement("button");
          bTurtle.type = "button";
          bTurtle.className = "btn mini";
          bTurtle.textContent = "üê¢";
          bTurtle.setAttribute("aria-pressed", "false");

          bPlay.addEventListener("click", () => speakFromButton(qText, qRaw, false, bTurtle));
          bTurtle.addEventListener("click", () => speakFromButton(qText, qRaw, true, bTurtle));

          qBtns.appendChild(bPlay);
          qBtns.appendChild(bTurtle);

          qLine.appendChild(qText);
          qLine.appendChild(qBtns);

          const answers = document.createElement("div");
          answers.className = "answersRow";

          const chosenText = w.chosen ? `${w.chosen}) ${w.q.opts[w.chosen]}` : "NO CONTESTASTE";
          const correctText = `${w.correct}) ${w.q.opts[w.correct]}`;

          const chosenRow = document.createElement("div");
          chosenRow.className = "tag chosen";
          const chosenRaw = `TU RESPUESTA: ${chosenText}`;
          chosenRow.textContent = chosenRaw;
          chosenRow.dataset.raw = chosenRaw;

          const correctRow = document.createElement("div");
          correctRow.className = "tag correct";
          const correctRaw = `RESPUESTA CORRECTA: ${correctText}`;
          correctRow.textContent = correctRaw;
          correctRow.dataset.raw = correctRaw;

          function makeReadBtns(targetEl, rawText){
            const wrap = document.createElement("div");
            wrap.className = "smallBtns";

            const p = document.createElement("button");
            p.type = "button";
            p.className = "btn mini";
            p.textContent = "‚ñ∂";

            const t = document.createElement("button");
            t.type = "button";
            t.className = "btn mini";
            t.textContent = "üê¢";
            t.setAttribute("aria-pressed", "false");

            p.addEventListener("click", () => speakFromButton(targetEl, rawText, false, t));
            t.addEventListener("click", () => speakFromButton(targetEl, rawText, true, t));

            wrap.appendChild(p);
            wrap.appendChild(t);
            return wrap;
          }

          const chosenWrap = document.createElement("div");
          chosenWrap.style.display = "flex";
          chosenWrap.style.gap = "10px";
          chosenWrap.style.justifyContent = "space-between";
          chosenWrap.style.alignItems = "flex-start";
          chosenWrap.style.flexWrap = "wrap";
          chosenWrap.appendChild(chosenRow);
          chosenWrap.appendChild(makeReadBtns(chosenRow, chosenRaw));

          const correctWrap = document.createElement("div");
          correctWrap.style.display = "flex";
          correctWrap.style.gap = "10px";
          correctWrap.style.justifyContent = "space-between";
          correctWrap.style.alignItems = "flex-start";
          correctWrap.style.flexWrap = "wrap";
          correctWrap.appendChild(correctRow);
          correctWrap.appendChild(makeReadBtns(correctRow, correctRaw));

          answers.appendChild(chosenWrap);
          answers.appendChild(correctWrap);

          item.appendChild(qLine);
          item.appendChild(answers);

          badList.appendChild(item);
        });
      }

      const back = document.getElementById("backNote");
      back.dataset.raw = "SI QUIERES REPETIR, RECARGA LA P√ÅGINA.";
      back.textContent = "SI QUIERES REPETIR, RECARGA LA P√ÅGINA.";

      // ‚úÖ GENERAR PDF AUTOM√ÅTICAMENTE AL ACABAR
      generatePDF();
    }

    // -----------------------------
    // EVENTS
    // -----------------------------
    function attachHeaderControls(){
      const titleEl = document.getElementById("titleText");
      const titlePlay = document.getElementById("titlePlay");
      const titleTurtle = document.getElementById("titleTurtle");
      const raw = getRawText(titleEl, titleEl.textContent);

      titlePlay.addEventListener("click", () => speakFromButton(titleEl, raw, false, titleTurtle));
      titleTurtle.addEventListener("click", () => speakFromButton(titleEl, raw, true, titleTurtle));
    }

    function attachGradeControls(){
      const gradeBtn = document.getElementById("gradeBtn");
      const gradePlay = document.getElementById("gradePlay");
      const gradeTurtle = document.getElementById("gradeTurtle");
      const raw = getRawText(gradeBtn, "CORREGIR Y NOTA");

      gradePlay.addEventListener("click", () => speakFromButton(gradeBtn, raw, false, gradeTurtle));
      gradeTurtle.addEventListener("click", () => speakFromButton(gradeBtn, raw, true, gradeTurtle));

      gradeBtn.addEventListener("click", () => {
        const ok = ensureAllAnswered();
        const warn = document.getElementById("warn");
        if (!ok){
          const msg = "FALTAN PREGUNTAS SIN RESPONDER. RESPONDE TODAS ANTES DE CORREGIR.";
          warn.dataset.raw = msg;
          warn.textContent = msg;
          speakNormal(msg);
          return;
        }
        warn.dataset.raw = "";
        warn.textContent = "";
        grade();
      });
    }

    function attachResultControls(){
      const play = document.getElementById("resultPlay");
      const turtle = document.getElementById("resultTurtle");
      const title = document.getElementById("resultTitle");

      // ‚úÖ FIX BUG: leer SIEMPRE desde state.resultSpeechText (texto estable)
      play.addEventListener("click", () => speakFromButton(title, state.resultSpeechText, false, turtle));
      turtle.addEventListener("click", () => speakFromButton(title, state.resultSpeechText, true, turtle));
    }

    function warmVoices(){
      if (!supportsSpeech()) return;
      window.speechSynthesis.getVoices();
    }

    // INIT
    render();
    attachHeaderControls();
    attachGradeControls();
    attachResultControls();
    warmVoices();

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopAllSpeech();
    });
  </script>
</body>
</html>
